name: Promote feature to test

on:
  push:
    tags:
      - "feat-*-test"

permissions:
  contents: write
  pull-request: write

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract branch & tag info
        id: info
        run: |
          TAG="${GITHUB_REF_NAME}"
          echo "tag=${tag}" >> $GITHUB_OUTPUT

          BRANCH=$(git branch -r --contains "$GITHUB_SHA" | sed 's|origin/||' | grep '^feature/' | head -n1 || true)

          if [ -z "$BRANCH" ]; THEN
            echo "No new feature branch found for commit $GITHUB_SHA"
            exit 1
          fi

          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "Feature branch: $BRANCH"

      - name: Ensure tag commit is on dev
        run: |
          git fetch origin dev
          if ! git merge-base --is-ancestor "$GITHUB_SHA" origin/dev; THEN
            echo "Tag commit $GITHUB_SHA is not reachable from origin/dev. Aborting promotion."
            exit 1
          fi
          echo "Tag commit is on origin/dev. Continuing."

      - name: Create PR from feature to test
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.info.outputs.branch }}"
          TAG="${{ steps.info.outputs.tag }}"

          TITLE="Promote ${BRANCH} to test (${tag})"
          BODY="Automated promotion of \`${BRANCH}\` to \`test\` for tag \`${tag}\`."

          if gh pr list --head "$BRANCH" --base "test" --state open --json number --jq '.[0].number' | grep -qE '^[0-9]+$'; THEN
            echo "PR from ${BRANCH} to test already exists."
          else
            gh pr create \
              --head "$BRANCH" \
              --base "test" \
              --title "$TITLE" \
              --body "$BODY"
          fi
