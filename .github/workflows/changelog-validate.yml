name: Validate Feature Changelog

on:
  pull_request:
    branches:
      - dev
      - test
      - preprod
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract feature branch name
        id: branch
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "Source branch: ${BRANCH}"
          
          # Only validate feature branches
          if [[ ! "$BRANCH" =~ ^feature/ ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Not a feature branch, skipping validation"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for changelog file
        if: steps.branch.outputs.skip == 'false'
        id: check_file
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          # Extract feature name from branch (feature/user-auth -> feat-user-auth)
          FEATURE_NAME=$(echo "$BRANCH" | sed 's|feature/|feat-|')
          CHANGELOG_FILE="changelogs/${FEATURE_NAME}.md"
          
          echo "Expected changelog: ${CHANGELOG_FILE}"
          
          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "file=${CHANGELOG_FILE}" >> $GITHUB_OUTPUT
            echo "❌ Changelog file missing: ${CHANGELOG_FILE}"
            exit 1
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "file=${CHANGELOG_FILE}" >> $GITHUB_OUTPUT
            echo "✅ Changelog file found: ${CHANGELOG_FILE}"
          fi

      - name: Validate changelog format
        if: steps.branch.outputs.skip == 'false' && steps.check_file.outputs.exists == 'true'
        run: |
          CHANGELOG_FILE="${{ steps.check_file.outputs.file }}"
          
          echo "Validating changelog format..."
          
          # Check for at least one required section header
          REQUIRED_SECTIONS=("### Added" "### Changed" "### Fixed" "### Removed" "### Deprecated" "### Security")
          HAS_SECTION=false
          
          for section in "${REQUIRED_SECTIONS[@]}"; do
            if grep -q "^${section}" "$CHANGELOG_FILE"; then
              echo "✅ Found section: ${section}"
              HAS_SECTION=true
            fi
          done
          
          if [ "$HAS_SECTION" = false ]; then
            echo "❌ No valid changelog sections found!"
            echo "Required: At least one of: ${REQUIRED_SECTIONS[*]}"
            exit 1
          fi
          
          # Check that sections have content (at least one bullet point after header)
          echo ""
          echo "Checking for content in sections..."
          
          while IFS= read -r line; do
            if [[ "$line" =~ ^###\ (Added|Changed|Fixed|Removed|Deprecated|Security)$ ]]; then
              CURRENT_SECTION="$line"
              HAS_CONTENT=false
            elif [[ -n "$CURRENT_SECTION" ]] && [[ "$line" =~ ^-\ .+ ]]; then
              echo "✅ ${CURRENT_SECTION} has content"
              HAS_CONTENT=true
              CURRENT_SECTION=""
            fi
          done < "$CHANGELOG_FILE"
          
          echo ""
          echo "✅ Changelog validation passed!"

      - name: Comment on PR (if validation fails)
        if: failure() && steps.branch.outputs.skip == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.branch.outputs.branch }}';
            const file = '${{ steps.check_file.outputs.file }}';
            const exists = '${{ steps.check_file.outputs.exists }}';
            
            let body = '## ❌ Changelog Validation Failed\n\n';
            
            if (exists === 'false') {
              body += `### Missing Changelog File\n\n`;
              body += `Expected file: \`${file}\`\n\n`;
              body += `Please create a changelog file with the following template:\n\n`;
              body += '```markdown\n';
              body += '### Added\n';
              body += '- \n\n';
              body += '### Changed\n';
              body += '- \n\n';
              body += '### Fixed\n';
              body += '- \n\n';
              body += '### Technical Notes\n';
              body += '- Database migrations: \n';
              body += '- New dependencies: \n';
              body += '- Configuration changes: \n';
              body += '```\n\n';
              body += '> Remove sections that are not applicable.\n';
            } else {
              body += `### Invalid Changelog Format\n\n`;
              body += `File: \`${file}\`\n\n`;
              body += `The changelog must contain at least one of these sections with content:\n`;
              body += `- \`### Added\`\n`;
              body += `- \`### Changed\`\n`;
              body += `- \`### Fixed\`\n`;
              body += `- \`### Removed\`\n`;
              body += `- \`### Deprecated\`\n`;
              body += `- \`### Security\`\n\n`;
              body += `Each section should have at least one bullet point.\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment on PR (if validation succeeds)
        if: success() && steps.branch.outputs.skip == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const file = '${{ steps.check_file.outputs.file }}';
            
            const body = `## ✅ Changelog Validation Passed\n\n` +
                        `Changelog file found and validated: \`${file}\`\n\n` +
                        `The changelog will be included in the release notes when this feature is promoted.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
